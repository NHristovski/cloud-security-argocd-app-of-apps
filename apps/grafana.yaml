apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: grafana
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  destination:
    namespace: monitoring
    server: https://kubernetes.default.svc
  project: default
  sources:
  - repoURL: https://grafana.github.io/helm-charts
    chart: grafana
    targetRevision: 8.13.1
    helm:
      values: |
        datasources:
          datasources.yaml:
            apiVersion: 1
            datasources:
              - name: Prometheus
                type: prometheus
                url: http://prometheus-server.monitoring.svc.cluster.local
                access: proxy
                isDefault: true
              - name: loki
                access: proxy
                type: loki
                jsonData:
                  httpHeaderName1: X-Scope-OrgID
                secureJsonData:
                  httpHeaderValue1: 1
                orgId: 1
                url: http://loki.monitoring.svc.cluster.local:3100
                
        dashboardProviders:
          dashboardproviders.yaml:
            apiVersion: 1
            providers:
              - name: "default"
                orgId: 1
                folder: ""
                type: file
                disableDeletion: false
                editable: true
                options:
                  path: /var/lib/grafana/dashboards/default
        dashboards:
          default:
            kubernetes:
              gnetId: 10000
              revision: 1
              datasource: Prometheus
        auth.generic_oauth:
          enabled: true
          name: Log in with KEYCLOAK  
          allow_sign_up: true
          client_id: grafana 
          client_secret: 0eRJapXkC3PJrxq5CdhY8DQ1CpRiuxml
          scopes: openid profile email groups roles 
          auth_url: http://keycloak.keycloak.svc.cluster.local:80/realms/grafana/protocol/openid-connect/auth
          token_url: http://keycloak.keycloak.svc.cluster.local:80/realms/grafana/protocol/openid-connect/token
          api_url: http://keycloak.keycloak.svc.cluster.local:80/realms/grafana/protocol/openid-connect/userinfo
          signout_redirect_url: http://keycloak.keycloak.svc.cluster.local:80/realms/grafana/protocol/openid-connect/logout
          role_attribute_strict: true
          role_attribute_path:  (contains(grafana.roles[], 'grafanaAdmin') && 'GrafanaAdmin') || (contains(grafana.roles[], 'admin') && 'Admin') || (contains(grafana.roles[], 'editor') && 'Editor') || 'Viewer'
          allow_assign_grafana_admin: true 
          email_attribute_path: email
          name_attribute_path: preferred_username
          login_attribute_path: preferred_username
        auth:
          disable_login_form: false
          oauth_auto_login: false
          oauth_skip_org_role_update_sync: false
          skip_org_role_sync: false
        users:
          auto_assign_org: true
          auto_assign_org_role: Viewer
          auto_assign_org_id: 1
        security:
          disable_initial_admin_creation: false
          allow_embedding: true
          cookie_secure: false
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true

